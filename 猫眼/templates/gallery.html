<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>猫眼电影数据可视化 - 3D 影廊</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        }

        /* 顶部标题栏 */
        #header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), transparent);
            z-index: 10;
            pointer-events: none;
            display: flex;
            align-items: center;
            padding-left: 20px;
        }

        #header h1 {
            color: #fff;
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* 侧边信息面板 - 玻璃拟态 */
        #info-panel {
            position: absolute;
            top: 100px;
            /* 避开头部 */
            left: 40px;
            width: 320px;
            padding: 25px;
            color: white;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            opacity: 0;
            transform: translateX(-20px);

            background: rgba(20, 20, 30, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #ef4238;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
        }

        #info-panel.active {
            opacity: 1;
            transform: translateX(0);
        }

        #movie-rank {
            font-size: 80px;
            font-weight: 900;
            color: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: -30px;
            right: 10px;
            z-index: -1;
            line-height: 1;
        }

        #movie-title {
            font-size: 32px;
            font-weight: 700;
            margin: 0 0 10px 0;
            background: linear-gradient(45deg, #fff, #ef4238);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #movie-score-container {
            display: flex;
            align-items: baseline;
            margin-bottom: 15px;
        }

        #movie-score {
            font-size: 48px;
            color: #ffb400;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(255, 180, 0, 0.4);
            margin-right: 10px;
        }

        .score-label {
            font-size: 14px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #movie-desc {
            font-size: 14px;
            color: #ccc;
            line-height: 1.6;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        /* 底部控制提示 */
        #controls-hint {
            position: absolute;
            bottom: 30px;
            width: 100%;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            letter-spacing: 2px;
            pointer-events: none;
            text-transform: uppercase;
        }

        /* 加载动画 */
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #ef4238;
            font-size: 24px;
            font-weight: 300;
            z-index: 100;
            transition: opacity 0.5s;
        }

        /* 选中态的光标样式 */
        body.hovering {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="loading">Initializing Neural Interface...</div>

    <div id="header">
        <h1>MAOYAN DATA VISUALIZATION // 3D GALLERY</h1>
    </div>

    <div id="info-panel">
        <div id="movie-rank">01</div>
        <h1 id="movie-title">Movie Title</h1>
        <div id="movie-score-container">
            <span class="score-label">Score</span>
            <span id="movie-score">9.5</span>
        </div>
        <div id="movie-desc">Hover over a card to view visual data analysis.</div>
    </div>

    <div id="controls-hint">// DRAG TO ROTATE &bull; SCROLL TO ZOOM // [V2.2 - SCRIPT FIXED]</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js?v=3",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 接收来自 Flask 的数据
        const movieData = {{ movies | tojson }};

        // --- 场景、相机、渲染器 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020205);
        scene.fog = new THREE.FogExp2(0x020205, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4, 16);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // --- 中央装置：实心发光三棱锥 ---
        const centerGroup = new THREE.Group();
        scene.add(centerGroup);

        const coreGeo = new THREE.ConeGeometry(3, 5, 3);
        const coreMat = new THREE.MeshStandardMaterial({
            color: 0xffffff,
            emissive: 0xffffff,
            emissiveIntensity: 1,
            metalness: 0.8,
            roughness: 0.2
        });
        const coreMesh = new THREE.Mesh(coreGeo, coreMat);
        centerGroup.add(coreMesh);

        const outerGeo = new THREE.ConeGeometry(5, 8, 3);
        const outerMat = new THREE.MeshBasicMaterial({
            color: 0x00ffff,
            wireframe: true,
            transparent: true,
            opacity: 0.8
        });
        const outerMesh = new THREE.Mesh(outerGeo, outerMat);
        centerGroup.add(outerMesh);

        const glowGeo = new THREE.ConeGeometry(5.2, 8.2, 3);
        const glowMat = new THREE.MeshBasicMaterial({
            color: 0xff00cc,
            wireframe: true,
            transparent: true,
            opacity: 0.4
        });
        const glowMesh = new THREE.Mesh(glowGeo, glowMat);
        centerGroup.add(glowMesh);

        // --- 粒子系统 ---
        const particleGeo = new THREE.BufferGeometry();
        const posArray = new Float32Array(300);
        for (let i = 0; i < 300; i++) posArray[i] = (Math.random() - 0.5) * 20;
        particleGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particleMat = new THREE.PointsMaterial({ size: 0.05, color: 0x00ffff, transparent: true, opacity: 0.5 });
        const particles = new THREE.Points(particleGeo, particleMat);
        scene.add(particles);

        // --- 科技纹理生成 (增强版：支持图片) ---
        function createCyberCardTexture(movie, callback) {
            const canvas = document.createElement('canvas');
            canvas.width = 512; canvas.height = 768;
            const ctx = canvas.getContext('2d');
            const baseColor = new THREE.Color(movie.color || "#ef4238");

            // 1. 背景
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, 512, 768);

            // 2. 加载并绘制海报图片 (通过代理)
            const img = new Image();
            img.crossOrigin = "anonymous";

            // 使用代理或直接访问 (如果是模拟数据自带的可用链接)
            const movieImgUrl = movie.image;
            img.src = movieImgUrl ? `/api/image_proxy?url=${encodeURIComponent(movieImgUrl)}` : '';

            img.onload = () => {
                // 绘制海报
                ctx.drawImage(img, 20, 20, 472, 600);

                // 遮罩渐变 (让底部文字更清晰)
                const grad = ctx.createLinearGradient(0, 400, 0, 768);
                grad.addColorStop(0, 'rgba(5,5,5,0)');
                grad.addColorStop(0.7, 'rgba(5,5,5,0.9)');
                grad.addColorStop(1, 'rgba(5,5,5,1)');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, 512, 768);

                drawOverlay();
                callback(new THREE.CanvasTexture(canvas));
            };

            img.onerror = () => {
                // 如果图片加载失败，绘制占位符
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(20, 20, 472, 600);
                drawOverlay();
                callback(new THREE.CanvasTexture(canvas));
            };

            function drawOverlay() {
                // 边框
                ctx.strokeStyle = baseColor.getStyle();
                ctx.lineWidth = 10;
                ctx.strokeRect(5, 5, 502, 758);

                // 标题
                ctx.fillStyle = '#ffffff';
                ctx.font = "bold 42px 'Microsoft YaHei'";
                ctx.textAlign = 'center';
                ctx.fillText(movie.title.substring(0, 10), 256, 680);

                // 评分
                ctx.fillStyle = '#ffb400';
                ctx.font = "bold 32px Arial";
                ctx.fillText(`SCORE: ${movie.score}`, 256, 730);

                // 排名
                ctx.font = "bold 150px Arial";
                ctx.globalAlpha = 0.1;
                ctx.fillText(movie.id, 400, 740);
                ctx.globalAlpha = 1.0;
            }
        }

        // --- 海报画廊 ---
        const galleryGroup = new THREE.Group();
        scene.add(galleryGroup);
        const posters = [];
        const radius = 10;

        // 修改为异步加载所有纹理后再关闭加载界面
        let loadedCount = 0;
        movieData.forEach((movie, index) => {
            const geometry = new THREE.PlaneGeometry(3.5, 5.25); // 稍微加大一点

            createCyberCardTexture(movie, (texture) => {
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.95
                });
                const mesh = new THREE.Mesh(geometry, material);

                const angle = (index / movieData.length) * Math.PI * 2;
                mesh.position.x = Math.sin(angle) * radius;
                mesh.position.z = Math.cos(angle) * radius;
                mesh.lookAt(0, 0, 0);
                mesh.rotation.y += Math.PI;

                mesh.userData = movie;
                galleryGroup.add(mesh);
                posters.push(mesh);

                loadedCount++;
                if (loadedCount === movieData.length) {
                    onAllLoaded();
                }
            });
        });

        function onAllLoaded() {
            // 隐藏加载层
            const loading = document.getElementById('loading');
            if (loading) {
                loading.style.opacity = '0';
                setTimeout(() => loading.style.display = 'none', 500);
            }
        }

        // --- 灯光 ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const centerLight = new THREE.PointLight(0x00ffff, 2, 20);
        scene.add(centerLight);

        // --- 交互控制器 ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();
        let hoveredMesh = null;

        window.addEventListener('pointermove', (e) => {
            pointer.x = (e.clientX / window.innerWidth) * 2 - 1;
            pointer.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });

        // --- 动画循环 ---
        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();

            const time = Date.now() * 0.001;
            if (coreMesh) { coreMesh.rotation.y = time * 0.5; coreMesh.rotation.z = time * 0.2; }
            if (outerMesh) { outerMesh.rotation.x = -time * 0.3; outerMesh.rotation.y = time * 0.1; }
            if (galleryGroup) galleryGroup.rotation.y += 0.0015;

            raycaster.setFromCamera(pointer, camera);
            const intersects = raycaster.intersectObjects(posters);
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if (hoveredMesh !== obj) {
                    if (hoveredMesh) hoveredMesh.scale.set(1, 1, 1);
                    hoveredMesh = obj;
                    obj.scale.set(1.1, 1.1, 1.1);
                    const info = document.getElementById('info-panel');
                    info.classList.add('active');
                    document.getElementById('movie-title').innerText = obj.userData.title;
                    document.getElementById('movie-score').innerText = obj.userData.score;
                }
            } else if (hoveredMesh) {
                hoveredMesh.scale.set(1, 1, 1);
                hoveredMesh = null;
                document.getElementById('info-panel').classList.remove('active');
            }

            renderer.render(scene, camera);
        }

        // 启动
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>